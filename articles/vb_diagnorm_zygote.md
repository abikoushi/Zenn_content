---
title: "‰∫ãÂæåÂàÜÂ∏É„ÇíÊ≠£Ë¶èÂàÜÂ∏É„ÅßËøë‰ºº„Åô„ÇãÂ§âÂàÜ„Éô„Ç§„Ç∫Ê≥ï"
emoji: "üìë"
type: "tech" # tech: ÊäÄË°ìË®ò‰∫ã / idea: „Ç¢„Ç§„Éá„Ç¢
topics: []
published: false
---



[È†àÂ±±„Äé„Éô„Ç§„Ç∫Êé®Ë´ñ„Å´„Çà„ÇãÊ©üÊ¢∞Â≠¶ÁøíÂÖ•ÈñÄ„Äè](https://amzn.to/3BHWbv1)„Åß„ÅØ„É≠„Ç∏„Çπ„ÉÜ„Ç£„ÉÉ„ÇØÂõûÂ∏∞„Å®„Éã„É•„Éº„É©„É´„Éç„ÉÉ„Éà„ÅÆ„Å®„Åì„Çç„ÅßËøë‰ºº‰∫ãÂæåÂàÜÂ∏É„Å®„Åó„Å¶Áã¨Á´ã„Å™Ê≠£Ë¶èÂàÜÂ∏É„Çí‰ªÆÂÆö„Åó„Å¶„ÄÅÂ§âÂàÜ„Éë„É©„É°„Éº„Çø„ÇíÂãæÈÖçÊ≥ï„ÅßÊé®ÂÆö„Åô„Çã„Ç¢„É´„Ç¥„É™„Ç∫„É†„ÅåÂá∫„Å¶„Åè„Çã„ÄÇ

ÂãæÈÖç„ÇíË©ï‰æ°„Åô„Çã„Å®„Åç„Å´„ÅØÂÜç„Éë„É©„É°„Éº„ÇøÂåñ„Éà„É™„ÉÉ„ÇØÔºàre-parameterization trickÔºâ„Å®„ÅÑ„ÅÜ„Ç¢„Ç§„Éá„Ç¢„Çí‰Ωø„ÅÜ„ÄÇ

„Åì„Çå„ÅØ„Éã„É•„Éº„É©„É´„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Å´Èôê„Çâ„Åö„Å©„Çì„Å™ÂàÜÂ∏É„Åß„ÇÇ‰Ωø„Åà„Çã„Ç¢„Ç§„Éá„Ç¢„Åß‰æøÂà©„Å†„Å®ÊÄù„Å£„Åü„ÅÆ„Åß„ÄÅ„Åæ„Å®„ÇÅÁõ¥„Åó„Å¶„Åø„Çã„ÄÇ

** „Ç¢„É´„Ç¥„É™„Ç∫„É†

„Åì„Åì„Åß„ÅØ„Éë„É©„É°„Éº„Çø„ÅÆÊ∑ªÂ≠ó„ÅØÁúÅÁï•„Åô„Çã„ÄÇ

„Åæ„Åö„Åô„Åπ„Å¶„ÅÆ„Éë„É©„É°„Éº„Çø $w$ „Å´ÂØæ„Åó„Å¶„ÄÅÂπ≥Âùá0„ÄÅÂàÜÊï£ $\lambda^{-1}$ „ÅÆÊ≠£Ë¶è‰∫ãÂâçÂàÜÂ∏É $p(w)$ „ÇíË®≠ÂÆö„Åô„Çã„ÄÇ

[tex:\displaystyle \log p(w) =\frac{1}{2} \log \lambda - \lambda \frac{w^2}{2}+\mathrm{Const.}]

„Åô„Åπ„Å¶„ÅÆ„Éë„É©„É°„Éº„Çø„ÅÆËøë‰ºº‰∫ãÂæåÂàÜÂ∏É„Å®„Åó„Å¶„ÄÅÂπ≥Âùá[tex:\mu]„ÄÅÂàÜÊï£ [tex:\sigma^{2}] „ÅÆÊ≠£Ë¶èÂàÜÂ∏É [tex:q(w)] „ÇíË®≠ÂÆö„Åô„Çã„ÄÇ

[tex:\displaystyle \log q(w) = - \log \sigma -  \frac{(w-\mu)^2}{2\sigma^2}+\mathrm{Const.}]

Ê®ôÊ∫ñÂÅèÂ∑Æ„ÅØÊ≠£„ÅÆÊï∞„Å™„ÅÆ„Åß $\sigma = \exp(\rho)$ „Å®„Åä„ÅÑ„Å¶„ÄÅ$\rho$ „ÇíÊúÄÈÅ©Âåñ„Åô„Çã„ÄÇ

„Äé„Éô„Ç§„Ç∫Êé®Ë´ñ„Å´„Çà„ÇãÊ©üÊ¢∞Â≠¶ÁøíÂÖ•ÈñÄ„Äè„Åß„ÅØ„ÄÅ$\sigma = \log(1+\exp(\rho))$ „Å®„Å™„Å£„Å¶„ÅÑ„Çã„Åå„ÄÅÂæÆÂàÜ„Çí„Åã„Çì„Åü„Çì„Å´„Åô„Çã„Åü„ÇÅ„ÄÅÊåáÊï∞Èñ¢Êï∞„Å´„Åó„Å¶„Åø„Åü„ÄÇ

Áúü„ÅÆ‰∫ãÂæåÂàÜÂ∏É„Å®„ÅÆ„Ç´„É´„Éê„ÉÉ„ÇØ„Éª„É©„Ç§„Éñ„É©Ë∑ùÈõ¢„ÅåËøë„ÅÑÊ≠£Ë¶èÂàÜÂ∏É„ÇíÊ±Ç„ÇÅ„Çã„ÅÆ„Åå„Ç¢„É´„Ç¥„É™„Ç∫„É†„ÅÆÁõÆÁöÑ„ÄÇ

Ê®ôÊ∫ñÊ≠£Ë¶è‰π±Êï∞ [tex:\varepsilon] „Çí‰Ωø„Å£„Å¶„Çµ„É≥„Éó„É´[tex: \tilde{w} = \mu + \sigma \tilde{\varepsilon}] „ÇíÂæó„Çã„Å®„Åì„Çå„ÅØ„ÄÅËøë‰ºº‰∫ãÂæåÂàÜÂ∏É„Åã„Çâ„ÅÆ„Çµ„É≥„Éó„É´„Åù„ÅÆ„ÇÇ„ÅÆ„Å´„Å™„Çã„ÄÇË¶≥Ê∏¨„Åï„Çå„ÅüÁõÆÁöÑÂ§âÊï∞„Çí [tex: Y]„ÄÅ Ë™¨ÊòéÂ§âÊï∞„Çí[tex: X] „Å®„Åó„Å¶„ÄÅÂ∞§Â∫¶„Çí [tex: p(Y|X,w)] „Å®Êõ∏„Åè„Å®Áúü„ÅÆ‰∫ãÂæåÂàÜÂ∏É„Å®Ëøë‰ºº‰∫ãÂæåÂ∏É„ÅÆ„Ç´„É´„Éê„ÉÉ„ÇØ„É©„Ç§„Éñ„É©Ë∑ùÈõ¢„ÅØ„ÄÅ

[tex: \displaystyle \operatorname{KL}(q(w)\|p(w|Y,X))\\
 \displaystyle \approx \log q(\tilde w)- \log p(\tilde w) - \log p(Y|X,\tilde w)+\mathrm{Const.}]

„Å®Ëøë‰ºº„Åß„Åç„Çã„ÄÇ

1ÂÄã„ÅÆ„Çµ„É≥„Éó„É´„ÅÆÊ®ôÊú¨Âπ≥Âùá„ÅßÊúüÂæÖÂÄ§„ÇíËøë‰ºº„Åó„Å¶„ÅÑ„Çã„Çè„Åë„Åß„ÄÅ„É¢„É≥„ÉÜ„Ç´„É´„É≠EM„Å®„Åã„Çí‰Ωø„Å£„Åü„Åì„Å®„Åå„ÅÇ„Çã‰∫∫„ÅØÂ§â„Å´ÊÑü„Åò„Çã„Åã„ÇÇ„Åó„Çå„Å™„ÅÑ„Åë„Çå„Åß„ÇÇ„ÄÅ„Åì„Çå„Åß„ÇÇ„Åë„Å£„Åì„ÅÜ„ÅÜ„Åæ„Åè„ÅÑ„Åè„ÄÇ„ÇÇ„Å°„Çç„ÇìË§áÊï∞„Çµ„É≥„Éó„É™„É≥„Ç∞„Åó„Å¶Âπ≥Âùá„Çí„Å®„Å£„Å¶„ÇÇ„Çà„ÅÑ„ÅåË®àÁÆó„ÅåÂ§ßÂ§â„Å´„Å™„Çã„ÄÇ

„ÅÇ„Å®„ÅØ„Åì„Çå„ÇíÂæÆÂàÜ„Åó„Å¶„ÄÅÂãæÈÖçÊ≥ï„Åß [tex:\mu] „Å® [tex:\sigma] „ÇíÊõ¥Êñ∞„Åó„Å¶„ÇÑ„Çã„ÄÇ

$$
 \log q(\tilde w) = - \log \sigma -  \frac{(\tilde w - \mu)^2}{2\sigma^2}+\mathrm{Const.}\\
= - \log \sigma -  \frac{(\mu+\sigma \varepsilon-\mu)^2}{2\sigma^2}+\mathrm{Const.}\\
 = - \log \sigma -  \frac{ \varepsilon^2}{2}+\mathrm{Const.}
$$

„Å™„ÅÆ„Åß„ÄÅ
[tex: \displaystyle \frac{d}{d\mu}\log q(\tilde w) =0]
[tex: \displaystyle \frac{d}{d\sigma}\log q(\tilde w) = (-1/\sigma)]
[tex: \displaystyle \frac{d}{d\mu}\log p(\tilde w) =-\lambda \tilde w]
[tex: \displaystyle \frac{d}{d\sigma}\log p(\tilde w) = -\lambda \tilde w \varepsilon]

„Åæ„Åü„ÄÅÂêàÊàêÈñ¢Êï∞„ÅÆÂæÆÂàÜ„Å™„ÅÆ„Åß„ÄÅ
[tex: \displaystyle \frac{d}{d\rho} \exp(\rho) =\exp(\rho)]
„ÇíÂøò„Çå„Å™„ÅÑ„Çà„ÅÜ„Å´„Åã„Åë„Å¶„ÇÑ„Çã„ÄÇ 

„Åæ„Å®„ÇÅ„Çã„Å®Ê¨°„ÅÆ„Ç¢„É´„Ç¥„É™„Ç∫„É†„ÅåÂæó„Çâ„Çå„Çã„ÄÇ
+ Â≠¶ÁøíÁéá [tex:\alpha] „Å® ‰∫ãÂâçÂàÜÂ∏É„ÅÆÁ≤æÂ∫¶„Éë„É©„É°„Éº„Çø [tex: \lambda] „ÇíË®≠ÂÆö„ÄÇ
+ [tex:\mu] „Å® [tex:\rho] „ÇíÈÅ©ÂΩì„Å´ÂàùÊúüÂåñ„Åó‰ª•‰∏ã„ÇíÁπ∞„ÇäËøî„Åô„ÄÇ
+ „Åô„Åπ„Å¶„ÅÆ„Éë„É©„É°„Éº„Çø„Å´ÂØæ„Åó„Å¶„ÄÅÊ®ôÊ∫ñÊ≠£Ë¶è‰π±Êï∞ [tex:\tilde{\varepsilon}] „Çí‰Ωø„Å£„Å¶„Çµ„É≥„Éó„É´ [tex: \tilde{w} = \mu + \exp(\rho) \tilde{\varepsilon}] „ÇíÂæó„Çã„ÄÇ 
+ [tex: g = -\frac{d}{dw} \log p(Y|X, \tilde w)] „ÇíË®àÁÆó„ÄÇ
+ [tex: g_\mu =  g + \lambda\tilde{w}] „Å®„Åô„Çã„ÄÇ
+ [tex: g_\rho = (g \tilde{\varepsilon} + \lambda \tilde{w} \tilde{\varepsilon})\exp(\rho) -1] „Å®„Åô„Çã„ÄÇ
+ [tex: \mu \leftarrow \mu + \alpha g_\mu] „ÅßÊõ¥Êñ∞
+ [tex: \rho \leftarrow \rho + \alpha g_\rho] „ÅßÊõ¥Êñ∞

** Julia „ÅÆ„Ç≥„Éº„Éâ

Julia „Å´„ÅØËá™ÂãïÂæÆÂàÜ„ÅÆ„Éë„ÉÉ„Ç±„Éº„Ç∏ ForwardDiff „Åå„ÅÇ„Çã„ÅÆ„ÅßÂØæÊï∞Â∞§Â∫¶„ÅÆÂæÆÂàÜ„ÅÆ„Å®„Åì„Çç„ÅØËá™ÂàÜ„ÅßË®àÁÆó„Åó„Å™„Åè„Å¶„Çà„ÅÑÔºàÂ†¥Âêà„ÇÇ„ÅÇ„ÇãÔºâ„ÄÇ

‰ªäÂõû„ÅØ‰π±Êï∞„ÅßÈÅ©ÂΩì„Å´‰Ωú„Å£„Åü„Éá„Éº„Çø„Åß„Éù„Ç¢„ÇΩ„É≥ÂõûÂ∏∞„Çí„ÇÑ„Å£„Å¶„Åø„Çã„ÄÇ

„Åì„Çì„Å™„Åµ„ÅÜ„Å†Ôºö

>|julia|

using Distributions
using ForwardDiff
using Random
using Plots
using Optim
using LinearAlgebra

function„ÄÄpoisonloss(beta,y,X)
    Xbeta = X*beta
    lambda = exp.(Xbeta)
    return -sum(y .* Xbeta - lambda)
end

function VIGD(f, par0, lambda, lr, maxiter::Int) 
    rng = Random.default_rng()
    len = length(par0)
    mu = randn(rng,len)
    rho = randn(rng,len)
    g(beta) = ForwardDiff.gradient(beta0 -> f(beta0),beta)
    logloss = zeros(maxiter)
    for i in 1:maxiter
    sigma = exp.(rho)
    epsilon = randn(rng,len)
    beta = mu + sigma.*epsilon
    fx = f(beta)
    gvec = g(beta)
    g_mu = gvec + lambda*beta
    g_rho = (gvec.*epsilon + lambda*beta.*epsilon).*sigma .- 1.0
    mu = mu - lr * g_mu
    rho = rho - lr * g_rho
    logloss[i] = fx
    end
    return mu, rho, logloss
end

rng = Random.default_rng()
Random.seed!(1)
x = sort(randn(rng,100))
X = [ones(100) x]
beta = [2.0,-1.0]

y = rand.(rng,Poisson.(exp.(X*beta)))

f(beta) = poisonloss(beta,y,X)
    
betaini = [0.0,0.0]
@time Œº, œÅ, logloss = VIGD(f, betaini, 0.0, 1.0e-4, 5000)
#Ë®àÁÆóÊôÇÈñì„ÅØ0.2Áßí„Åè„Çâ„ÅÑ

plot(logloss,legend=false)

Œµ = randn(rng,2,1000)
betasmp = Œº .+ exp.(œÅ).*Œµ 

post = exp.(X*betasmp)
pred = rand.(rng,Poisson.(post))
predmean = mean(pred,dims=2)
lwr = [quantile(pred[i,:],0.025) for i in 1:100]
upr = [quantile(pred[i,:],0.975) for i in 1:100]

scatter(x,y,legend=false)
plot!(x,predmean, color="blue")
plot!(x,lwr,color="blue", linestyle = :dash)
plot!(x,upr,color="blue", linestyle = :dash)
png("./Desktop/plot.png")

opt = optimize(f,betaini,method=BFGS(),autodiff=:forward)
Œ≤ = Optim.minimizer(opt)
se = sqrt.(diag(inv(Symmetric(ForwardDiff.hessian(f,Œ≤)))))
||<

poisonloss „ÅÆ„Å®„Åì„Çç„ÇíÊõ∏„ÅçÊèõ„Åà„Çå„Å∞„É≠„Ç∏„Çπ„ÉÜ„Ç£„ÉÉ„ÇØÂõûÂ∏∞„Åß„ÇÇ„ÉØ„Ç§„Éñ„É´ÂõûÂ∏∞„Åß„ÇÇ„Åß„Åç„Çã„ÅØ„Åö„ÄÇ

‰∫àÊ∏¨ÂàÜÂ∏É„ÅÆ95%Âå∫Èñì„ÇíÁÇπÁ∑ö„Åß„Éó„É≠„ÉÉ„Éà„Åó„Åü„ÄÇ

[f:id:abrahamcow:20201229143541p:plain]

Ë®àÁÆó„ÅåÈÄ≤„ÇÄ„Å´„Å§„Çå„Å¶Ë≤†„ÅÆÂØæÊï∞Â∞§Â∫¶„ÅåÂ∞è„Åï„Åè„Å™„Å£„Å¶„ÅÑ„ÅèÊßòÂ≠ê„Åß„Åô„ÄÇ

[f:id:abrahamcow:20201229143941p:plain]

„Å°„Å™„Åø„Å´ÊúÄÂ∞§Êé®ÂÆö„ÅÆÊ®ôÊ∫ñË™§Â∑Æ„Å´„Åè„Çâ„Åπ„Çã„Å®Â§âÂàÜËøë‰ºº„Åó„Åü‰∫ãÂæåÂàÜÂ∏É„ÅÆÊ®ôÊ∫ñÂÅèÂ∑Æ„ÅØ„ÇÑ„ÇÑÂ∞è„Åï„ÇÅ„Å´Ê±Ç„Åæ„Çã„ÄÇ

>|julia|
julia> println(Œº)
[1.999546299946068, -1.0194307666319837]

julia> println(Œ≤)
[2.0010916047667635, -1.0185383086714856]

julia> println(exp.(œÅ))
[0.035814747235478735, 0.026642018884133416]

julia> println(se)
[0.04194236834667879, 0.031554017967900964]
||<

„Å®„ÅØ„ÅÑ„Åà„ÄÅÂπ≥Âùá„ÅØ„Å®„ÇÇ„Åã„ÅèÊ®ôÊ∫ñÂÅèÂ∑Æ„ÅÆ„Åª„ÅÜ„ÅØ„Ç§„ÉÜ„É¨„Éº„Ç∑„Éß„É≥„ÅÆÂõûÊï∞„Å´„Çà„Å£„Å¶„Åë„Å£„Åì„ÅÜÂ§â„Çè„Çã„ÄÇ

** „ÇÇ„Å£„Å®Â≠¶„Å≥„Åü„ÅÑ‰∫∫„ÅÆ„Åü„ÇÅ„Å´

[https://arxiv.org/abs/1505.05424:title]

Èñ¢ÈÄ£„Ç®„É≥„Éà„É™Ôºö[https://selfboast.hatenablog.jp/entry/2022/01/01/110919:title]
